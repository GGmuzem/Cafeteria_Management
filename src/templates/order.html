{% extends "base.html" %}

{% block title %}Оформление заказа - Вкусная Столовая{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 30px;">
    <h1><i class="fas fa-cash-register"></i> Оформление заказа</h1>
</div>

<!-- Search Student Form -->
<div class="card" style="margin-bottom: 30px;">
    <form method="GET" action="{{ url_for('order') }}" style="display: flex; gap: 15px; align-items: flex-end;">
        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
            <label class="form-label">Поиск ученика по логину:</label>
            <input type="text" name="student_login" value="{{ target_user.login if target_user else '' }}"
                class="form-control" placeholder="Введите логин ученика" required>
        </div>
        <button type="submit" class="btn btn-primary" style="height: 48px;">
            <i class="fas fa-search"></i> Найти
        </button>
    </form>
</div>

{% if target_user %}
<div class="card" style="margin-bottom: 30px; border-left: 5px solid var(--secondary-color);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="margin-bottom: 5px;">Ученик: {{ target_user.login }}</h3>
            <p style="color: #666; margin: 0;">Баланс: <strong style="color: var(--success-color); font-size: 1.2em;">{{
                    balance }} ₽</strong></p>
        </div>
        <div style="text-align: right;">
            {% if target_user.allergen %}
            <span class="badge" style="background: var(--danger-color); color: white;">Аллергия: {{ target_user.allergen
                }}</span>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filter Meal Type -->
<div style="margin-bottom: 20px; display: flex; gap: 10px;">
    <a href="{{ url_for('order', student_login=target_user.login) }}"
        class="btn {% if not current_meal_type %}btn-primary{% else %}btn-outline{% endif %}">Все</a>
    <a href="{{ url_for('order', meal_type='Завтрак', student_login=target_user.login) }}"
        class="btn {% if current_meal_type == 'Завтрак' %}btn-primary{% else %}btn-outline{% endif %}">Завтрак</a>
    <a href="{{ url_for('order', meal_type='Обед', student_login=target_user.login) }}"
        class="btn {% if current_meal_type == 'Обед' %}btn-primary{% else %}btn-outline{% endif %}">Обед</a>
</div>

<form method="POST">
    <input type="hidden" name="student_login" value="{{ target_user.login }}">

    <div style="margin-bottom: 20px;">
        <button type="button" class="btn btn-outline btn-sm" onclick="toggleAll()">
            <i class="fas fa-check-double"></i> Выбрать все / Снять выделение
        </button>
    </div>

    <div class="grid menu-container">
        {% for item in items %}
        <div class="card menu-item"
            style="position: relative; {% if not item.is_suitable %}border-color: var(--danger-color); background-color: #fff5f5;{% endif %}">
            <div style="position: absolute; top: 15px; right: 15px;">
                <input type="checkbox" name="food_ids" value="{{ item.obj.id }}" class="food-checkbox"
                    style="transform: scale(1.5);">
            </div>

            <div class="menu-content">
                <h3 style="margin-right: 30px;">{{ item.obj.name }}</h3>
                <span class="menu-item-price">{{ item.obj.price }} ₽</span>
                <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                    <span class="badge" style="margin-right: 5px;">{{ item.obj.meal_type }}</span>
                    {% if item.obj.composition is mapping %}
                    {{ item.obj.composition.get('ingredients', []) | join(', ') }}
                    {% else %}
                    {{ item.obj.composition }}
                    {% endif %}
                </p>

                {% if not item.is_suitable %}
                <div style="margin-top: 10px; color: var(--danger-color); font-weight: bold; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-triangle"></i> {{ item.warning }}
                </div>
                {% else %}
                <div style="margin-top: 10px; color: var(--success-color); font-weight: bold; font-size: 0.9rem;">
                    <i class="fas fa-check-circle"></i> Подходит
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="card" style="grid-column: 1 / -1; text-align: center;">
            <p>Меню пусто.</p>
        </div>
        {% endfor %}
    </div>

    {% if items %}
    <div
        style="margin-top: 30px; position: sticky; bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 500;">Выберите блюда и нажмите кнопку</span>
        <button type="submit" class="btn btn-success" style="font-size: 1.1rem; padding: 10px 30px;">
            <i class="fas fa-shopping-cart"></i> Купить выбранное
        </button>
    </div>
    {% endif %}
</form>

{% else %}
<div class="card" style="text-align: center; padding: 50px;">
    <i class="fas fa-user-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
    <h3>Поиск ученика</h3>
    <p>Пожалуйста, введите логин ученика, чтобы начать оформление заказа.</p>
</div>
{% endif %}

<script>
    function toggleAll() {
        var checkboxes = document.querySelectorAll('.food-checkbox');
        var allChecked = true;
        // Проверяем, все ли уже выбраны
        for (var i = 0; i < checkboxes.length; i++) {
            if (!checkboxes[i].checked) {
                allChecked = false;
                break;
            }
        }
        // Инвертируем состояние
        checkboxes.forEach(function (cb) {
            cb.checked = !allChecked;
        });
    }
</script>
{% endblock %}