{% extends "base.html" %}

{% block title %}Оформление заказа - Вкусная Столовая{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 30px;">
    <h1><i class="fas fa-cash-register"></i> Оформление заказа</h1>
</div>

<style>
    .alert {
        color: #333 !important;
    }
</style>

<!-- Search Student Form -->
<div class="card" style="margin-bottom: 30px;">
    <form method="GET" action="{{ url_for('order') }}" style="display: flex; gap: 15px; align-items: flex-end;">
        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
            <label class="form-label">Поиск ученика по логину:</label>
            <input type="text" name="student_login" value="{{ target_user.login if target_user else '' }}"
                class="form-control" placeholder="Введите логин ученика" required>
        </div>
        <button type="submit" class="btn btn-primary" style="height: 48px;">
            <i class="fas fa-search"></i> Найти
        </button>
    </form>
</div>

{% if target_user %}
<div class="card" style="margin-bottom: 30px; border-left: 5px solid var(--secondary-color);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h3 style="margin-bottom: 5px;">Ученик: {{ target_user.login }}</h3>
            <p style="color: #666; margin: 0;">Баланс: <strong style="color: var(--success-color); font-size: 1.2em;">{{
                    balance }} ₽</strong></p>
        </div>
        <div style="text-align: right;">
            {% if target_user.allergen %}
            <span class="badge" style="background: var(--danger-color); color: white;">Аллергия: {{ target_user.allergen
                }}</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="grid" style="grid-template-columns: 1fr 1fr; gap: 30px;">
    {% for meal_type, data in meals.items() %}
    <div class="card" style="display: flex; flex-direction: column; height: 100%;">
        <div
            style="border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">{{ meal_type }}</h2>
            <span style="font-size: 1.5em; font-weight: bold; color: var(--primary-color);">{{ data.total_price }}
                ₽</span>
        </div>

        <div style="flex-grow: 1; overflow-y: auto; max-height: 400px; padding-right: 5px;">
            {% if data.dishes %}
            <ul style="list-style: none; padding: 0;">
                {% for item in data.dishes %}
                <li style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee;">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>{{ item.obj.name }}</strong>
                        <span>{{ item.obj.price }} ₽</span>
                    </div>
                    <div style="font-size: 0.85em; color: #666;">
                        {% if item.obj.composition is mapping %}
                        {{ item.obj.composition.get('ingredients', []) | join(', ') }}
                        {% else %}
                        {{ item.obj.composition }}
                        {% endif %}
                    </div>
                    {% if not item.is_suitable %}
                    <div style="color: var(--danger-color); font-size: 0.8em; margin-top: 2px;">
                        <i class="fas fa-exclamation-triangle"></i> {{ item.warning }}
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="color: #666; font-style: italic;">Меню пусто.</p>
            {% endif %}
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            {% if data.has_warning %}
            <div class="alert alert-warning" style="margin-bottom: 15px; padding: 10px; font-size: 0.9em;">
                <i class="fas fa-exclamation-triangle"></i> Внимание! В составе есть аллергены ученика.
            </div>
            {% endif %}

            <form method="POST" action="{{ url_for('order') }}">
                <input type="hidden" name="student_login" value="{{ target_user.login }}">
                <input type="hidden" name="meal_type" value="{{ meal_type }}">

                <button type="submit" class="btn btn-success" style="width: 100%;" {% if not data.dishes %}disabled{%
                    endif %}>
                    <i class="fas fa-utensils"></i> Выдать {{ meal_type }}
                </button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="card" style="text-align: center; padding: 50px;">
    <i class="fas fa-user-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
    <h3>Поиск ученика</h3>
    <p>Пожалуйста, введите логин ученика, чтобы начать оформление заказа.</p>
</div>
{% endif %}

<script>
    function toggleAll() {
        var checkboxes = document.querySelectorAll('.food-checkbox');
        var allChecked = true;
        // Проверяем, все ли уже выбраны
        for (var i = 0; i < checkboxes.length; i++) {
            if (!checkboxes[i].checked) {
                allChecked = false;
                break;
            }
        }
        // Инвертируем состояние
        checkboxes.forEach(function (cb) {
            cb.checked = !allChecked;
        });
    }
</script>
{% endblock %}