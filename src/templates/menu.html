{% extends "base.html" %}

{% block title %}Меню - Вкусная Столовая{% endblock %}

{% block content %}
<div class="page-header"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h1>Наше Меню</h1>

    {% if current_user.role in ['cook', 'admin'] %}
    <a href="{{ url_for('cook.cook_panel') }}" class="btn btn-secondary">
        <i class="fas fa-hat-chef"></i> Панель повара
    </a>
    {% endif %}
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 30px;">
    <form action="{{ url_for('menu') }}" method="get"
        style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
        <div class="form-group" style="margin-bottom: 0; flex-grow: 1;">
            <label for="allergen" class="form-label">Исключить аллерген:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="allergen" name="allergen" value="{{ request.args.get('allergen', '') }}"
                    class="form-control" placeholder="Например: лук, орехи">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
        </div>
        {% if request.args.get('allergen') %}
        <a href="{{ url_for('menu') }}" class="btn btn-outline" style="align-self: flex-end;">Сбросить</a>
        {% endif %}
    </form>
</div>

<div class="grid menu-container" style="display: block;">
    {% for meal_type in ['Завтрак', 'Обед'] %}
    <div class="meal-section" style="margin-bottom: 40px;">
        <h2
            style="border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; color: var(--primary-color);">
            {{ meal_type }}
        </h2>

        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            {% set ns = namespace(found=false) %}
            {% for item in menu_items %}
            {% if item.meal_type == meal_type %}
            {% set ns.found = true %}
            <div class="card menu-item">
                <div class="menu-content">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="margin: 0;">{{ item.name }}</h3>
                        <span class="menu-item-price">{{ item.price }} ₽</span>
                    </div>

                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        <i class="fas fa-utensils" style="color: var(--secondary-color);"></i>
                        {% if item.composition is mapping %}
                        {{ item.composition.get('ingredients', []) | join(', ') }}
                        {% else %}
                        {{ item.composition }}
                        {% endif %}
                    </p>

                    {% if item.composition is mapping and item.composition.get('weight') %}
                    <p style="color: #888; font-size: 0.8rem; margin-bottom: 15px;">
                        <i class="fas fa-weight-hanging"></i> {{ item.composition.weight }} г.
                    </p>
                    {% endif %}
                </div>

                <div class="menu-actions" style="margin-top: auto; padding-top: 15px; border-top: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <a href="{{ url_for('menu_reviews', menu_id=item.id) }}" class="btn btn-outline"
                            style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="far fa-comment-dots"></i> Отзывы
                        </a>

                        <form action="{{ url_for('buy_food', food_id=item.id) }}" method="get" style="display: inline;">
                            <button type="submit" class="btn btn-primary" style="padding: 5px 15px;">
                                Купить
                            </button>
                        </form>
                    </div>

                    {% if current_user.role in ['cook', 'admin'] %}
                    <div
                        style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd; display: flex; gap: 10px; justify-content: flex-end;">
                        <a href="{{ url_for('cook.edit_menu', id=item.id) }}"
                            style="color: var(--secondary-color); font-size: 0.9rem;">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{{ url_for('cook.delete_menu', id=item.id) }}" onclick="return confirm('Вы уверены?');"
                            style="color: var(--danger-color); font-size: 0.9rem;">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endfor %}

            {% if not ns.found %}
            <div class="card"
                style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #888; background: #f9f9f9;">
                <p>В этом разделе пока нет блюд</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}